---
title: "Plotting the effect sizes after adjustment using mashr"
output: 
  workflowr::wflow_html:
    code_folding: hide 
---

```{r message=FALSE, warning=FALSE, results="hide"}
library(dplyr)
library(readr)
library(ggplot2)
library(gridExtra)
library(tidyr)

db <- DBI::dbConnect(RSQLite::SQLite(), 
                     "data/derived/annotations.sqlite3")

# Results for all 1,613,615 SNPs, even those that are in 100% LD with others (these are grouped up by the SNP_clump column)
all_snps <- tbl(db, "univariate_lmm_results")

# All SNPs and SNP groups that are in <100% LD with one another (n = 1,207,357)
SNP_clumps <- all_snps %>% select(-SNP) %>% distinct() %>% collect(n=Inf)
```


## Inspecting the effect of adaptive shrinkage on the SNP effect size estimates

The plots reveal that the R package `mashr`, which implements multivariate adaptive shrinkage, was effective at shrinking the effect size estimates towards zero. The amount of shrinkage applied was slightly stronger when applying `mashr` using data-driven covariance matrices, as opposed to 'canonical' covariance matrices that were selected _a priori_ by us. 

```{r}
hex_plot <- function(x, y, xlab, ylab){
  ggplot(SNP_clumps, aes_string(x, y)) + 
    geom_abline(linetype = 2) + 
    geom_vline(xintercept = 0, linetype = 3) +
    geom_hline(yintercept = 0, linetype = 3) +
    stat_binhex(bins = 200, colour = "#FFFFFF00") + 
    scale_fill_distiller(palette = "Purples") + 
    coord_cartesian(xlim = c(-1,1), ylim = c(-0.55, 0.3)) + 
    theme_minimal() + xlab(xlab) + ylab(ylab) +
    theme(legend.position = "none")
}
grid.arrange(
  hex_plot("beta_female_early_raw", 
           "beta_female_early_mashr_canonical", 
           "Raw estimate of SNP effect size from LMM", 
           "Corrected estimate from mashr (canonical)"),
  hex_plot("beta_female_early_raw", 
           "beta_female_early_mashr_ED", 
           "Raw estimate of SNP effect size from LMM", 
           "Corrected estimate from mashr (data-driven)"),
  hex_plot("beta_female_early_mashr_canonical", 
         "beta_female_early_mashr_ED", 
         "Corrected estimate from mashr (canonical)", 
         "Corrected estimate from mashr (data-driven)"),
  ncol = 3)
```


## Relationship between raw $p$-values and the local false sign rate

The local false sign rate (defined as the probability that a SNP's true effect is non-zero _and_ has the same sign as the effect size estimate) was positively correlated with the raw p-value, as expected. 

Note that the false sign rate is sometimes 'more significant' than the $p$-value; one likely reason for this is that the local false sign rate (LFSR) uses the information provided by the correlations among SNP effects on our four fitness traits, while the $p$-value ignores this information. 

A second reason why the LFSR is often higher is that the LFSR was (noisily) estimated using a Markov chain, in a Bayesian model that incorporates priors, while the $p$-value is estimated by maximum likelihood (so there is no _statistical_ noise) and comes from a frequentist model lacking priors (or rather, it has a completely flat prior, unlike the mashr analysis).

The LFSR from the canonical and data-driven approaches are pretty much the same, though results from the data-drive `mashr` analysis are slightly 'more significant' on average (shown by the preponderance of points above the line $y = x$). 

```{r}
hex_plot2 <- function(p, xlab, ylab){
    p + 
    geom_abline(linetype = 2) + 
    stat_binhex(bins = 200, colour = "#FFFFFF00") + 
    scale_fill_distiller(palette = "Blues") + 
    scale_x_continuous(expand = c(0,0)) + scale_y_continuous(expand = c(0,0)) +
    coord_cartesian(xlim = c(0, 8), ylim = c(0, 8)) + 
    theme_minimal() + xlab(xlab) + ylab(ylab) +
    theme(legend.position = "none")
}

grid.arrange(
  SNP_clumps %>% 
    ggplot(aes(-log10(pvalue_female_early_raw), 
               -log10(LFSR_female_early_mashr_canonical))) %>%
    hex_plot2("-log10 p-value from LMM", 
              "-log10 local false sign rate (canonical)"),
  SNP_clumps %>% 
    ggplot(aes(-log10(pvalue_female_early_raw), 
               -log10(LFSR_female_early_mashr_ED))) %>% 
    hex_plot2("-log10 p-value from LMM", 
              "-log10 local false sign rate (data-driven)"),
  SNP_clumps %>% 
    ggplot(aes(-log10(LFSR_female_early_mashr_canonical), 
               -log10(LFSR_female_early_mashr_ED))) %>% 
    hex_plot2("-log10 local false sign\nrate (canonical)", 
              "-log10 local false sign rate (data-driven)"),
  ncol = 3)
```


## Conclusion

Based on these plots, we elected to focus on the results generated by the data-driven `mashr` analysis, as opposed to the canonical `mashr` analysis. This is more conservative, because the effect sizes and local false sign rates are more moderate in the data-driven analysis. Also, using the data-driven approach yields estimates that are independent of our prior expectations about the possible covariance structures that might exist in the data, and is therefore more robust if our expectations are wrong.
