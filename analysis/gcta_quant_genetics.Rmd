---
title: "Estimating genetic (co)variance and heritability"
output: 
  workflowr::wflow_html:
    code_folding: hide 
  
---

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(glue)
library(kableExtra)
library(brms)
gcta <- file.path(getwd(), "code/gcta64")
options(readr.show_col_types = FALSE)


# helper function to pass commands to the terminal
# Note that we set `intern = TRUE`, and pass the result of `system()` to `cat()`,
# ensuring that the Terminal output will be printed in this knitr report.
run_command <- function(shell_command, wd = getwd(), path = ""){
  cat(system(glue("cd ", wd, path, "\n", shell_command), intern = TRUE), sep = '\n')
}

# Load the line mean fitness values calculated by brms
line_means <- read_csv("data/derived/predicted_line_means.csv") %>% 
  mutate(line = factor(str_remove_all(line, "_"))) %>%
  filter(!is.na(male.fitness.early)) %>%
  mutate(`Female fitness early` = female.fitness.early,
         `Female fitness late` = female.fitness.late,
         `Male fitness early` = male.fitness.early,
         `Male fitness late` = male.fitness.late) %>%
  rename(female_fitness_early = female.fitness.early,
         female_fitness_late = female.fitness.late,
         male_fitness_early = male.fitness.early,
         male_fitness_late = male.fitness.late)
```

## Proportion of variance in fitness explained by 'DGRP line':
The table shows the posterior estimate of the intra-class correlation coefficient (ICC, which measures the proportion of variance within and between lines), using the models in the script `get_predicted_line_means.Rmd` to adjust for block effects (and one covariate in the male late-life fitness analysis). ICC was calculated using `ICC::ICCbare`. This value approximates the broad-sense heritability; fitness appears highly heritable, except for male late-life fitness. 
```{r comment=''}
read.csv('data/derived/ICC.csv') %>% 
  select(Fitness_trait, Estimate, Est.Error, Q2.5, Q97.5) %>%
  rename(`Fitness trait` = Fitness_trait, `Est. Error` = Est.Error, `Lower 95% CI` = Q2.5, `Upper 95% CI` = Q97.5) %>% 
  kable(digits = 2) %>% kable_styling(full_width = FALSE)
```

### Correlations in the line means

```{r}
line_mean_corrs <- line_means %>% select(contains(" ")) %>% cor() %>% as.data.frame() 
saveRDS(line_mean_corrs, "data/derived/line_mean_corrs.rds")

line_mean_corrs %>% kable(digits =3) %>% kable_styling()
```


<!-- ```{r} -->
<!-- relatedness_matrix <- read_tsv("../DGRP_sexual_conflict/gwas_data/input/relatedness_matrix.txt") -->
<!-- rownam <- relatedness_matrix %>% pull(var) -->
<!-- relatedness_matrix <- as.matrix(relatedness_matrix[,-1]) -->
<!-- rownames(relatedness_matrix) <- str_extract(rownam, "line_[:digit:]*") -->
<!-- colnames(relatedness_matrix) <- str_extract(colnames(relatedness_matrix), "line_[:digit:]*") -->
<!-- relatedness_matrix[lower.tri(relatedness_matrix)] <- NA -->

<!-- relatedness_matrix <- relatedness_matrix %>%  -->
<!--   as.data.frame() %>%  -->
<!--   rownames_to_column("line1") %>%  -->
<!--   gather(line2, relatedness, -line1) %>%  -->
<!--   filter(!is.na(relatedness) & line1 != line2) %>% as_tibble() -->

<!-- list_lines_to_prune <- function(relatedness_matrix){ -->

<!--   set.seed(1) -->

<!--   line_set_to_prune_df <- relatedness_matrix %>%  -->
<!--     filter(relatedness > 0.2) %>%  -->
<!--     arrange(-relatedness) %>% as.data.frame() -->

<!--   line_set_to_prune <- line_set_to_prune_df$line1 -->
<!--   counter <- 1 -->
<!--   while(nrow(line_set_to_prune_df) > 0){ -->
<!--     line_set_to_prune[counter] <- line_set_to_prune_df[1, sample(2,1)] -->
<!--     counter <- counter + 1 -->
<!--     line_set_to_prune_df <- line_set_to_prune_df[-1, ] -->
<!--   } -->
<!--   line_set_to_prune -->
<!-- } -->

<!-- lines_to_prune <- list_lines_to_prune(relatedness_matrix) -->
<!-- ``` -->

## Use `gcta64` to estimate the genetic variances and heritabilities for each fitness trait

### Make a genomic relatedness matrix for all the lines

This uses the `gcta64` command `--make-grm` to make a genomic relatedness matrix (GRM) for the DGRP SNP data. This matrix is needed to run the GREML models below.
```{r}
run_command(glue("{gcta} --bfile dgrp2_QC_all_lines",
                 " --make-grm",
                 " --out gcta_GRM"), path = "/data/derived/")
```

### Run 4 univariate GREML models to find genetic variances and heritabilities

The below uses the `gcta64` command `--reml` to estimate the genetic variance (`V(G)`), i.e. the variance explained by the GRM), environmental variance (`V(e)`), their sum (`Vp`), and the so-called "SNP heritability" (`V(G)/Vp`). Note that the genetic variance is very low for male late-life fitness. This is a bit puzzling because the same is not true for male early-life fitness, which is strongly correlated across lines with male late-life fitness.

```{r}
do_univariate_greml <- function(trait1){

  # First make 'focal_data', a 2-column data frame with the line and the focal phenotype value
  focal_data <- line_means %>%
    select(line, !! trait1)
  names(focal_data)[2] <- c("focal_pheno")
  
  # Write a file with the line and phenotype data called phenotype.txt, for gcta64
  pheno_data <- focal_data %>%
    # filter(!(line %in% lines_to_prune)) %>% 
    mutate(line_copy = line) %>%
    select(line, line_copy, focal_pheno) %>%
    as.matrix()
  
  pheno_data %>%
    write.table(row.names = FALSE, col.names = FALSE,
                file = "data/derived/phenotype.txt", quote = FALSE)
  
  console_output <- suppressWarnings(capture.output(
    run_command(glue("{gcta}  --reml --reml-maxit 10000 --grm gcta_GRM  --pheno phenotype.txt  --out delete_me"), 
                path = "/data/derived/")))
  
  errors <- console_output[str_detect(console_output, "[Ee]rror")]
  if(length(errors) == 0) errors <- NA
  if(length(errors) > 1) errors <- paste(errors, sep = "; ")

  rbind(read.delim("data/derived/delete_me.hsq", sep = "\t") , 
        data.frame(Source = "Errors", Variance = errors, SE = NA)) %>% 
    mutate(Trait = trait1) %>% select(Trait, everything())
}

univariate_table <- bind_rows(do_univariate_greml("Female fitness early"),
          do_univariate_greml("Female fitness late"),
          do_univariate_greml("Male fitness early"),
          do_univariate_greml("Male fitness late")) %>% 
  filter(Source %in% c("V(G)", "V(e)", "Vp", "V(G)/Vp")) %>% 
  mutate(Variance = as.numeric(Variance)) %>% 
  rename(Parameter = Source) 

univariate_table %>% 
  kable(digits = 3) %>% 
  kable_styling(full_width = FALSE)
```

### Run 6 bivariate GREML models to find the genetic covariances/correlations

The below uses the `gcta64` command `--reml-bivar` to estimate the genetic covariances (`C(G)_tr12`), i.e. the co-variance explained by the GRM), and the genetic correlation (`rG`), in addition to the univariate parameters for trait 1 and trait 2 mentioned above. Note that because the genetic variance is low for male late-life fitness, the model cannot reliably estimate genetic covariance or correlations for pairs of traits that involve male late-life fitness.

```{r}
do_bivar_greml <- function(trait1, trait2){

  # First make 'focal_data', a 2-column data frame with the line and the focal phenotype value
  focal_data <- line_means %>%
    select(line, !! trait1, !! trait2)
  names(focal_data)[2:3] <- c("focal_pheno1", "focal_pheno2")
  
  # Write a file with the line and phenotype data called phenotype.txt, for gcta64
  pheno_data <- focal_data %>%
    # filter(!(line %in% lines_to_prune)) %>% 
    mutate(line_copy = line) %>%
    select(line, line_copy, focal_pheno1, focal_pheno2) %>%
    as.matrix()
  
  pheno_data %>%
    write.table(row.names = FALSE, col.names = FALSE,
                file = "data/derived/phenotype_pair.txt", quote = FALSE)
  
  # Note that the warnings come when gcta could not fit the model properly. I save these errors especially, so no need to print them.
  console_output <- suppressWarnings(capture.output(
    run_command(glue("{gcta}  --reml-bivar --reml-bivar-lrt-rg 0 --reml-maxit 10000 --grm gcta_GRM  --pheno phenotype_pair.txt  --out delete_me"), 
                path = "/data/derived/")))
  
  errors <- console_output[str_detect(console_output, "[Ee]rror")]
  if(length(errors) == 0) errors <- NA
  if(length(errors) > 1) errors <- paste(errors, sep = "; ")
  traits <- sort(c(trait1, trait2))
  
  rbind(read.delim("data/derived/delete_me.hsq", sep = "\t") , 
        data.frame(Source = "Errors", Variance = errors, SE = NA)) %>% 
    mutate(`Trait 1` = traits[1], `Trait 2` = traits[2]) %>% select(`Trait 1`, `Trait 2`, everything())
}

results <- bind_rows(do_bivar_greml("Female fitness early", "Female fitness late"),
          do_bivar_greml("Male fitness early", "Male fitness late"),
          do_bivar_greml("Female fitness early", "Male fitness early"),
          do_bivar_greml("Female fitness late", "Male fitness late"),
          do_bivar_greml("Female fitness early", "Male fitness late"),
          do_bivar_greml("Female fitness late", "Male fitness early")) %>% 
  filter(Source %in% c("V(G)_tr1", "V(e)_tr1", "Vp_tr1", "V(G)/Vp_tr1",
                       "V(G)_tr2", "V(e)_tr2", "Vp_tr2", "V(G)/Vp_tr2",
                       "C(G)_tr12", "rG")) %>% 
  mutate(Variance = as.numeric(Variance)) %>% 
  rename(Parameter = Source)

unlink(c("data/derived/delete_me.log", "data/derived/phenotype_pair.txt", "data/derived/delete_me.hsq"))
unlink(list.files("data/derived/", pattern = "gcta_GRM", full.names = TRUE))

results %>% 
  kable(digit = 3) %>% 
  kable_styling(full_width = FALSE)
```

### Set up the G-matrix shown in the supplementary table

```{r}
G_mat <- bind_rows(
  univariate_table %>% filter(Parameter == "V(G)") %>% mutate(`Trait 1` = Trait, `Trait 2` = Trait) %>% select(`Trait 1`, `Trait 2`, vcov = Variance, SE),
  results %>% filter(Parameter == "C(G)_tr12") %>% select(`Trait 1`, `Trait 2`, vcov = Variance, SE)) %>% 
  mutate(text = paste(format(round(vcov, 2), nsmall = 2), " (", format(round(SE, 2), nsmall = 2), ")", sep = "")) %>% 
  select(-vcov, -SE) %>% 
  spread(`Trait 1`, text)
rownames(G_mat) <- G_mat[,1]
G_mat <- G_mat[,-1]
G_mat[is.na(G_mat)] <- ""

saveRDS(G_mat, "data/derived/G_mat.rds")

G_mat %>% kable() %>% kable_styling()
```

