<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>GWAS for fitness in Drosophila</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/anchor-sections-1.0/anchor-sections.css" rel="stylesheet" />
<script src="site_libs/anchor-sections-1.0/anchor-sections.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />

<link rel="icon" href="https://github.com/workflowr/workflowr-assets/raw/master/img/reproducible.png">
<!-- Add a small amount of space between sections. -->
<style type="text/css">
div.section {
  padding-top: 12px;
}
</style>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">fitnessGWAS</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="license.html">License</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/lukeholman/fitnessGWAS">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">

<div class="btn-group pull-right">
<button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">GWAS for fitness in Drosophila</h1>

</div>


<p>
<button type="button" class="btn btn-default btn-workflowr btn-workflowr-report" data-toggle="collapse" data-target="#workflowr-report">
<span class="glyphicon glyphicon-list" aria-hidden="true"></span> workflowr <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span>
</button>
</p>
<div id="workflowr-report" class="collapse">
<ul class="nav nav-tabs">
<li class="active">
<a data-toggle="tab" href="#summary">Summary</a>
</li>
<li>
<a data-toggle="tab" href="#checks"> Checks <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> </a>
</li>
<li>
<a data-toggle="tab" href="#versions">Past versions</a>
</li>
</ul>
<div class="tab-content">
<div id="summary" class="tab-pane fade in active">
<p>
<strong>Last updated:</strong> 2021-03-04
</p>
<p>
<strong>Checks:</strong> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> 7 <span class="glyphicon glyphicon-exclamation-sign text-danger" aria-hidden="true"></span> 0
</p>
<p>
<strong>Knit directory:</strong> <code>fitnessGWAS/</code> <span class="glyphicon glyphicon-question-sign" aria-hidden="true" title="This is the local directory in which the code in this file was executed."> </span>
</p>
<p>
This reproducible <a href="http://rmarkdown.rstudio.com">R Markdown</a> analysis was created with <a
  href="https://github.com/jdblischak/workflowr">workflowr</a> (version 1.6.2). The <em>Checks</em> tab describes the reproducibility checks that were applied when the results were created. The <em>Past versions</em> tab lists the development history.
</p>
<hr>
</div>
<div id="checks" class="tab-pane fade">
<div id="workflowr-checks" class="panel-group">
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongRMarkdownfilestronguptodate"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>R Markdown file:</strong> up-to-date </a>
</p>
</div>
<div id="strongRMarkdownfilestronguptodate" class="panel-collapse collapse">
<div class="panel-body">
<p>Great! Since the R Markdown file has been committed to the Git repository, you know the exact version of the code that produced these results.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongEnvironmentstrongempty"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>Environment:</strong> empty </a>
</p>
</div>
<div id="strongEnvironmentstrongempty" class="panel-collapse collapse">
<div class="panel-body">
<p>Great job! The global environment was empty. Objects defined in the global environment can affect the analysis in your R Markdown file in unknown ways. For reproduciblity it’s best to always run the code in an empty environment.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongSeedstrongcodesetseed20180914code"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>Seed:</strong> <code>set.seed(20180914)</code> </a>
</p>
</div>
<div id="strongSeedstrongcodesetseed20180914code" class="panel-collapse collapse">
<div class="panel-body">
<p>The command <code>set.seed(20180914)</code> was run prior to running the code in the R Markdown file. Setting a seed ensures that any results that rely on randomness, e.g. subsampling or permutations, are reproducible.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongSessioninformationstrongrecorded"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>Session information:</strong> recorded </a>
</p>
</div>
<div id="strongSessioninformationstrongrecorded" class="panel-collapse collapse">
<div class="panel-body">
<p>Great job! Recording the operating system, R version, and package versions is critical for reproducibility.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongCachestrongnone"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>Cache:</strong> none </a>
</p>
</div>
<div id="strongCachestrongnone" class="panel-collapse collapse">
<div class="panel-body">
<p>Nice! There were no cached chunks for this analysis, so you can be confident that you successfully produced the results during this run.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongFilepathsstrongrelative"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>File paths:</strong> relative </a>
</p>
</div>
<div id="strongFilepathsstrongrelative" class="panel-collapse collapse">
<div class="panel-body">
<p>Great job! Using relative paths to the files within your workflowr project makes it easier to run your code on other machines.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongRepositoryversionstrongahrefhttpsgithubcomlukeholmanfitnessGWAStree3855d3359649c74f955042725d07276742cb649atargetblank3855d33a"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>Repository version:</strong> <a href="https://github.com/lukeholman/fitnessGWAS/tree/3855d3359649c74f955042725d07276742cb649a" target="_blank">3855d33</a> </a>
</p>
</div>
<div id="strongRepositoryversionstrongahrefhttpsgithubcomlukeholmanfitnessGWAStree3855d3359649c74f955042725d07276742cb649atargetblank3855d33a" class="panel-collapse collapse">
<div class="panel-body">
<p>
Great! You are using Git for version control. Tracking code development and connecting the code version to the results is critical for reproducibility.
</p>
<p>
The results in this page were generated with repository version <a href="https://github.com/lukeholman/fitnessGWAS/tree/3855d3359649c74f955042725d07276742cb649a" target="_blank">3855d33</a>. See the <em>Past versions</em> tab to see a history of the changes made to the R Markdown and HTML files.
</p>
<p>
Note that you need to be careful to ensure that all relevant files for the analysis have been committed to Git prior to generating the results (you can use <code>wflow_publish</code> or <code>wflow_git_commit</code>). workflowr only checks the R Markdown file, but you know if there are other scripts or data files that it depends on. Below is the status of the Git repository when the results were generated:
</p>
<pre><code>
Ignored files:
    Ignored:    .DS_Store
    Ignored:    .Rapp.history
    Ignored:    .Rhistory
    Ignored:    .Rproj.user/
    Ignored:    .httr-oauth
    Ignored:    .pversion
    Ignored:    analysis/.DS_Store
    Ignored:    analysis/correlations_SNP_effects_cache/
    Ignored:    analysis/plot_models_variant_effects_cache/
    Ignored:    code/.DS_Store
    Ignored:    code/Drosophila_GWAS.Rmd
    Ignored:    data/.DS_Store
    Ignored:    data/derived/
    Ignored:    data/input/.DS_Store
    Ignored:    data/input/.pversion
    Ignored:    data/input/dgrp.fb557.annot.txt
    Ignored:    data/input/dgrp2.bed
    Ignored:    data/input/dgrp2.bim
    Ignored:    data/input/dgrp2.fam
    Ignored:    data/input/huang_transcriptome/
    Ignored:    figures/.DS_Store

Untracked files:
    Untracked:  data/argweaver/
    Untracked:  data/input/TF_binding_sites.csv

</code></pre>
<p>
Note that any generated files, e.g. HTML, png, CSS, etc., are not included in this status report because it is ok for generated content to have uncommitted changes.
</p>
</div>
</div>
</div>
</div>
<hr>
</div>
<div id="versions" class="tab-pane fade">

<p>
These are the previous versions of the repository in which changes were made to the R Markdown (<code>analysis/perform_gwas.Rmd</code>) and HTML (<code>docs/perform_gwas.html</code>) files. If you’ve configured a remote Git repository (see <code>?wflow_git_remote</code>), click on the hyperlinks in the table below to view the files as they were in that past version.
</p>
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
File
</th>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
<th>
Message
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
html
</td>
<td>
<a href="https://rawcdn.githack.com/lukeholman/fitnessGWAS/871ae81fa56175675b53d22ca29bf9323c3ed50a/docs/perform_gwas.html" target="_blank">871ae81</a>
</td>
<td>
lukeholman
</td>
<td>
2021-03-04
</td>
<td>
Build site.
</td>
</tr>
<tr>
<td>
html
</td>
<td>
<a href="https://rawcdn.githack.com/lukeholman/fitnessGWAS/e112260eb7edb940edc701a4180d2cf98f9d1145/docs/perform_gwas.html" target="_blank">e112260</a>
</td>
<td>
lukeholman
</td>
<td>
2021-03-04
</td>
<td>
Build site.
</td>
</tr>
<tr>
<td>
html
</td>
<td>
<a href="https://rawcdn.githack.com/lukeholman/fitnessGWAS/836a780685e8ac20355b0a92672276f7ca763481/docs/perform_gwas.html" target="_blank">836a780</a>
</td>
<td>
lukeholman
</td>
<td>
2021-03-04
</td>
<td>
Build site.
</td>
</tr>
<tr>
<td>
html
</td>
<td>
<a href="https://rawcdn.githack.com/lukeholman/fitnessGWAS/359ff37c4f4021451e81122393307a28013165a9/docs/perform_gwas.html" target="_blank">359ff37</a>
</td>
<td>
lukeholman
</td>
<td>
2021-03-04
</td>
<td>
Build site.
</td>
</tr>
<tr>
<td>
html
</td>
<td>
<a href="https://rawcdn.githack.com/lukeholman/fitnessGWAS/5506c4b50ea385dbe5174320ad41d797c64d0676/docs/perform_gwas.html" target="_blank">5506c4b</a>
</td>
<td>
lukeholman
</td>
<td>
2021-03-04
</td>
<td>
Build site.
</td>
</tr>
<tr>
<td>
html
</td>
<td>
<a href="https://rawcdn.githack.com/lukeholman/fitnessGWAS/f64a3e97eddb218609bfe9dd0b9c3b4d282b51b2/docs/perform_gwas.html" target="_blank">f64a3e9</a>
</td>
<td>
lukeholman
</td>
<td>
2021-03-04
</td>
<td>
Build site.
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/lukeholman/fitnessGWAS/blob/fa1b9b0ab0805beb3f89b75330f07950953fc892/analysis/perform_gwas.Rmd" target="_blank">fa1b9b0</a>
</td>
<td>
lukeholman
</td>
<td>
2021-03-04
</td>
<td>
big first commit 2021
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
<a href="https://github.com/lukeholman/fitnessGWAS/blob/8d54ea56db332d3ac2d391c232936a4dc8106cc1/analysis/perform_gwas.Rmd" target="_blank">8d54ea5</a>
</td>
<td>
Luke Holman
</td>
<td>
2018-12-23
</td>
<td>
Initial commit
</td>
</tr>
<tr>
<td>
html
</td>
<td>
<a href="https://rawcdn.githack.com/lukeholman/fitnessGWAS/8d54ea56db332d3ac2d391c232936a4dc8106cc1/docs/perform_gwas.html" target="_blank">8d54ea5</a>
</td>
<td>
Luke Holman
</td>
<td>
2018-12-23
</td>
<td>
Initial commit
</td>
</tr>
</tbody>
</table>
</div>
<hr>
</div>
</div>
</div>
<pre class="r"><code>library(dplyr)
library(ggplot2)
library(ggdendro)
library(glue)
library(bigsnpr) # to install:   devtools::install_github(&quot;privefl/bigsnpr&quot;)
library(readr)
library(pander)
library(purrr)
library(future.apply) # for parallel code

# Load the predicted line means, as calculated by get_predicted_line_means
predicted_line_means &lt;- read_csv(&quot;data/derived/predicted_line_means.csv&quot;)

# # Load the wolbachia infection status data from the DGRP website
# wolbachia &lt;- read_csv(&quot;data/input/wolbachia.csv&quot;) %&gt;% 
#   mutate(line = paste(&quot;line&quot;, line, sep = &quot;&quot;))
# 
# # Load the chomosomal inversion data from the DGRP website
# # these are the 5 inversions that Huang et al. PNAS corrected for
# inversions &lt;- read_csv(&quot;data/input/inversion genotypes.csv&quot;) %&gt;%
#     mutate(line = paste(&quot;line&quot;, line, sep = &quot;&quot;)) %&gt;%
#     select(line, `In(2L)t`, `In(2R)NS`, `In(3R)P`, `In(3R)K`, `In(3R)Mo`) 

# helper function to pass commands to the terminal
# Note that we set `intern = TRUE`, and pass the result of `system()` to `cat()`, 
# ensuring that the Terminal output will be printed in this knitr report. 
run_command &lt;- function(shell_command, wd = getwd(), path = &quot;&quot;){
  cat(system(glue(&quot;cd &quot;, wd, path, &quot;\n&quot;,shell_command), intern = TRUE), sep = &#39;\n&#39;)
}</code></pre>
<div id="perform-snp-quality-control-and-imputation" class="section level2">
<h2>Perform SNP quality control and imputation</h2>
<p>We cleaned up the DGRP’s .bed/.bim/.fam files (available from the <a href="http://dgrp2.gnets.ncsu.edu/">Mackay lab website</a>) as follows:</p>
<ol style="list-style-type: decimal">
<li>Remove any SNPs for which genotypes are missing for &gt;10% of the DGRP lines. We then use the software <a href="https://faculty.washington.edu/browning/beagle/beagle.html">Beagle</a> to impute the remaining missing genotypes.</li>
<li>Remove SNPs with a minor allele frequency of less than 5%</li>
</ol>
<p>Note that in the PLINK-formatted genotype files, lines fixed for the major allele are coded as 2, and lines fixed for the minor allele as 0. This means that in the association tests we calculate, negative effect sizes mean that the minor allele is associated with lower fitness, while positive effect sizes means that the minor allele is associated with higher fitness.</p>
<pre class="r"><code>plink  &lt;- bigsnpr::download_plink()
beagle &lt;- bigsnpr::download_beagle()

perform_SNP_QC_and_imputation &lt;- function(phenotypes){
  
  if(&quot;block&quot; %in% names(phenotypes)) phenotypes &lt;- phenotypes %&gt;% select(-block)
  
  # Make a list of the lines in our sample and save as a text file for passing to PLINK
  lines_to_keep &lt;- gsub(&quot;_&quot;, &quot;&quot;, phenotypes$line) %&gt;% cbind(.,.)
  write.table(lines_to_keep, row.names = FALSE, col.names = FALSE, file = &quot;data/derived/lines_to_keep.txt&quot;, quote = FALSE)
  
  # Define a function to add our phenotype data to a .fam file, which is needed for GWAS analysis and to make sure PLINK includes these samples
  # The &#39;phenotypes&#39; data frame needs to have a column called &#39;line&#39;
  add_phenotypes_to_fam &lt;- function(filepath, phenotypes){
    read_delim(filepath, col_names = FALSE, delim = &quot; &quot;) %&gt;% 
      select(X1, X2, X3, X4, X5) %&gt;% # Get all the non-phenotype columns
      left_join(phenotypes %&gt;% 
                  mutate(line = gsub(&quot;_&quot;, &quot;&quot;, line)), 
                by = c(&quot;X1&quot; = &quot;line&quot;)) %&gt;%
      write.table(file = filepath, 
                  col.names = FALSE, row.names = FALSE, 
                  quote = FALSE, sep = &quot; &quot;)
  }
  
  # Use Plink to clean and subset the DGRP&#39;s SNP data as follows:
  # Only keep SNPs for which at least 90% of DGRP lines were successfully genotyped (--geno 0.1)
  # Only keep SNPs with a minor allele frequency of 0.05 or higher (--maf 0.05)
  # Finally, write the processed BIM/BED/FAM files to the data/derived directory
  run_command(glue(&quot;{plink} --bfile dgrp2&quot;,
                   &quot; --geno 0.1 --maf 0.05 --allow-no-sex&quot;, 
                   &quot; --make-bed --out ../derived/dgrp2_QC_all_lines&quot;), path = &quot;/data/input/&quot;)
  
  # Use the shell command &#39;sed&#39; to remove underscores from the DGRP line names in the .fam file (e.g. &#39;line_120&#39; becomes &#39;line120&#39;)
  # Otherwise, these underscores cause trouble when we need to convert from PLINK to vcf format (vcf format uses underscore as a separator)
  for(i in 1:2) run_command(&quot;sed -i &#39;&#39; &#39;s/_//&#39; dgrp2_QC_all_lines.fam&quot;, path = &quot;/data/derived/&quot;)
  
  # Now impute the missing genotypes using Beagle
  # This part uses the data for the full DGRP panel of &gt;200 lines, to infer missing genotypes as accurately as possible. 
  # This step uses a lot of memory (I set to 28MB max, and it used 26.5GB), but maybe it can also run on a less powerful computer?
  # The bigsnpr package provides a helpful wrapper for Beagle called snp_beagleImpute(): it translates to a VCF file and back again using PLINK
  snp_beagleImpute(beagle, plink, 
                   bedfile.in = &quot;data/derived/dgrp2_QC_all_lines.bed&quot;, 
                   bedfile.out = &quot;data/derived/dgrp2_QC_all_lines_imputed.bed&quot;,
                   ncores = 7, 
                   memory.max = 20)
  
  # assign a sex of &#39;female&#39; to all the DGRP lines (Beagle removes the sex, and it seems PLINK needs individuals to have a sex, 
  # despite PLINK having a command called --allow-no-sex)
  run_command(&quot;sed -i &#39;&#39; &#39;s/    0   0   0/  0   0   2/&#39; dgrp2_QC_all_lines_imputed.fam&quot;, path = &quot;/data/derived/&quot;)
  
  # Re-write the .bed file, to make sure the MAF threshold and minor/major allele designations are correctly assigned post-Beagle
  run_command(glue(&quot;{plink} --bfile dgrp2_QC_all_lines_imputed&quot;,
                   &quot; --geno 0.1 --maf 0.05 --allow-no-sex&quot;, 
                   &quot; --make-bed --out dgrp2_QC_all_lines_imputed_correct&quot;), path = &quot;/data/derived/&quot;)
  #unlink(list.files(&quot;data/derived&quot;, pattern = &quot;~&quot;, full.names = TRUE)) # delete the original files, which were given a ~ file name by PLINK
  
  # Use PLINK to get the allele IDs and calculate the MAFs across the whole DGRP, for all SNPs that survived QC
  # The file created is called data/derived/plink.frq
  run_command(&quot;{plink} --bfile dgrp2_QC_all_lines_imputed_correct --freq&quot;, path = &quot;/data/derived&quot;)

  # Now cull the PLINK files to just the lines that we measured, and re-apply the MAF cut-off of 0.05 for the new smaller sample of DGRP lines
  run_command(glue(&quot;{plink} --bfile dgrp2_QC_all_lines_imputed_correct&quot;,
                   &quot; --keep-allele-order&quot;, # force PLINK to retain the major/minor allele designations that apply to the DGRP as a whole
                   &quot; --keep lines_to_keep.txt --geno 0.1 --maf 0.05&quot;, 
                   &quot; --make-bed --out dgrp2_QC_focal_lines&quot;), path = &quot;/data/derived/&quot;)
  
  # edit the new FAM file to add the phenotype data from &#39;phenotypes&#39;
  add_phenotypes_to_fam(&quot;data/derived/dgrp2_QC_focal_lines.fam&quot;, phenotypes)
  
  # Clean up:
  unlink(c(&quot;data/derived/lines_to_keep.txt&quot;, 
           &quot;data/derived/plink.log&quot;,
           &quot;data/derived/dgrp2_QC_all_lines_imputed.bed&quot;,
           &quot;data/derived/dgrp2_QC_all_lines_imputed.bim&quot;,
           &quot;data/derived/dgrp2_QC_all_lines_imputed.fam&quot;,
           &quot;data/derived/dgrp2_QC_all_lines_imputed.log&quot;))
}

perform_SNP_QC_and_imputation(phenotypes = predicted_line_means)</code></pre>
</div>
<div id="run-gwas-using-gemma" class="section level2">
<h2>Run GWAS using GEMMA</h2>
<!-- ### Create a file of _Wolbachia_ infection status -->
<!-- GEMMA requires that the "covariate" file be in a specific format. Each row needs to match an individual (i.e. a DGRP line) in the PLINK file, and the order should be the same. Each column is one of the covariates. To fit an intercept in addition to the covariates, there should be a column of 1s. Thus, here we make a two-column tsv file wiht the intercept in column 1, and the _Wolbachia_ infection status (a y or a n) in column 2. We elected not to fit the presence/absence of the major inversions (as in sometimes done in studies of the DGRP), since that seems like a trait that will already be captured by the decomposed eigenvectors of the SNP data (since inversions create a block of linked SNPs). -->
<!-- ```{r eval=FALSE} -->
<!-- # Get the lines for the coming GWAS from the FAM file -->
<!-- lines_in_fam <- read_delim("data/derived/dgrp2_QC_focal_lines.fam",  -->
<!--                            col_names = FALSE, delim = " ") %>%  -->
<!--   select(X1) %>% rename(line = X1) -->
<!-- # merge in the covariates: the intercept, the Wolbachia, and the Inversion genotypes -->
<!-- covariates <- left_join(lines_in_fam, wolbachia, by = "line") %>% -->
<!--   left_join(inversions %>% -->
<!--               rename(Inv_1 = `In(2L)t`, -->
<!--                      Inv_2 = `In(2R)NS`, -->
<!--                      Inv_3 = `In(3R)P`, -->
<!--                      Inv_4 = `In(3R)K`, -->
<!--                      Inv_5 = `In(3R)Mo`), by = "line") %>% -->
<!--   mutate(intercept = 1, -->
<!--          wolbachia = as.numeric(ifelse(wolbachia == "y", 1, 0))) %>%  -->
<!--   select(intercept, wolbachia, Inv_1, Inv_2, Inv_3, Inv_4, Inv_5) -->
<!-- write_delim(covariates, path = "data/derived/covariate_file_for_GEMMA.txt", col_names = FALSE) -->
<!-- ``` -->
<div id="decompose-the-genomic-relatedness-matrix" class="section level3">
<h3>Decompose the genomic relatedness matrix</h3>
<p>This step is needed as a set up for the mixed model association tests, which use the eigenvectors and values of the GRM to adjust for ‘population structure’ among our samples.</p>
<pre class="r"><code># Any command with {bed} uses this particular PLINK file, double-checking that all the SNPs have MAF &gt; 0.05
bed &lt;- &quot;dgrp2_QC_focal_lines -maf 0.05&quot; 
#cov &lt;- &quot;-c covariate_file_for_GEMMA.txt&quot; # not used at present

# Calculate the *centered* GRM for the focal lines (option -gk 1)
run_command(&quot;gemma -bfile {bed} -r2 0.99 -gk 1 -o GRM&quot;, path = &quot;/data/derived&quot;) 

# Perform decomposition of the GRM, and save its eigenvalues and eigenvectors
run_command(&quot;gemma -bfile {bed} -r2 0.99 -k ./output/GRM.cXX.txt -eigen -o eigen_decomp&quot;, path = &quot;/data/derived&quot;) 

# Remove eigen vectors + values for which the eigenvalue is close to zero, and save the modified file
values &lt;- read_tsv(&quot;data/derived/output/eigen_decomp.eigenD.txt&quot;, col_names = &quot;eigenvalue&quot;)$eigenvalue
vectors &lt;- read_tsv(&quot;data/derived/output/eigen_decomp.eigenU.txt&quot;, col_names = FALSE)
missing_row &lt;- which(is.na(read_delim(&quot;data/derived/dgrp2_QC_focal_lines.fam&quot;, delim = &quot; &quot;, col_names = FALSE)$X8))

write_tsv(vectors, path = &quot;data/derived/output/eigen_decomp.eigenU_female.txt&quot;, col_names = FALSE)
write_tsv(data.frame(values), path = &quot;data/derived/output/eigen_decomp.eigenD_female.txt&quot;, col_names = FALSE)

write_tsv(vectors[-missing_row, -missing_row], path = &quot;data/derived/output/eigen_decomp.eigenU_male.txt&quot;, col_names = FALSE)
write_tsv(data.frame(values[-missing_row]), path = &quot;data/derived/output/eigen_decomp.eigenD_male.txt&quot;, col_names = FALSE)
unlink(&quot;data/derived/output/eigen_decomp.eigenD.txt&quot;)
unlink(&quot;data/derived/output/eigen_decomp.eigenU.txt&quot;)
# vectors &lt;- vectors[,-(which(values &lt; 0.2))]
# values &lt;- values[-(which(values &lt; 0.2))]
# write_tsv(vectors, path = &quot;data/derived/output/eigen_decomp.eigenU.txt&quot;, col_names = FALSE)
# write_tsv(data.frame(value = values), path = &quot;data/derived/output/eigen_decomp.eigenD.txt&quot;, col_names = FALSE)</code></pre>
</div>
<div id="run-univariate-and-multivariate-association-tests" class="section level3">
<h3>Run univariate and multivariate association tests</h3>
<p>The following code chunk runs 5 linear mixed models, implemented in <a href="http://www.xzlab.org/software/GEMMAmanual.pdf">GEMMA</a>. Each of the univariate linear mixed models uses the decomposed genomic relatedness matrix from above, and has one of our four fitness traits as the response variable. The multivariate model contains all four traits, and also uses the decomposed genomic relatedness matrix.</p>
<pre class="r"><code># The option &quot;-lmm 1&quot; runs a linear mixed model using Wald test to get the p-values
# The option &quot;-r2 0.95&quot; only keeps SNPs that are &lt;95% correlated with Wolbachia infection status
# The option &quot;-c covariate_file_for_GEMMA.txt&quot; adds in the Wolbahia infection status as a covariate, and also tells the model to fit an intercept
opts &lt;- &quot;-lmm 1&quot;
GRM_female &lt;- &quot;-d ./output/eigen_decomp.eigenD_female.txt -u ./output/eigen_decomp.eigenU_female.txt&quot;
GRM_male &lt;- &quot;-d ./output/eigen_decomp.eigenD_male.txt -u ./output/eigen_decomp.eigenU_male.txt&quot;
#cov &lt;- &quot;-c covariate_file_for_GEMMA.txt -r2 0.99&quot; # not used at present

c(&quot;gemma -bfile {bed} {GRM_female} {opts} -n 1 -o female_early_lmm&quot;,
  &quot;gemma -bfile {bed} {GRM_female} {opts} -n 2 -o female_late_lmm&quot;,
  &quot;gemma -bfile {bed} {GRM_male} {opts} -n 3 -o male_early_lmm&quot;,
  &quot;gemma -bfile {bed} {GRM_male} {opts} -n 4 -o male_late_lmm&quot;) %&gt;%
  #&quot;gemma -bfile {bed} {GRM_male} {opts} -n 1 2 3 4 -o all_four_traits&quot;) %&gt;% 
  lapply(run_command, path = &quot;/data/derived&quot;)</code></pre>
</div>
<div id="inspect-the-gemma-log-files-from-the-association-tests" class="section level3 tabset">
<h3>Inspect the GEMMA log files from the association tests</h3>
<p>According to the manual, GEMMA calculates the relatedness matrix from the SNP data, then “extracts the matrix elements corresponding to the analyzed individuals (which may be smaller than the number of total individuals), centers the matrix, and then performs an eigendecomposition”. The aim is to better estimate the effects of each SNP independently of the rest of the genome.</p>
<p>The metric <code>pve</code> in the outputs below is “the proportion of variance in the phenotype explained by typed genotypes”, also called SNP heritability. Next, <code>vg</code> is <span class="math inline">\(V_g\)</span>, the variance in phenotype due to variance in genotype, while <code>ve</code> is <span class="math inline">\(V_e\)</span>, the variance in phenotype due to variance in environment.</p>
<div id="female-early-life-fitness" class="section level4">
<h4>Female early-life fitness</h4>
<pre class="r"><code>cat(readLines(&quot;data/derived/output/female_early_lmm.log.txt&quot;), sep = &quot;\n&quot;)</code></pre>
<pre><code>##
## GEMMA Version    = 0.98 (2018-09-28)
## Build profile    = /gnu/store/79fw0qqlgpk7n8vll6lnlc4ahahn4gbw-profile
## GCC version      = 4.2.1
## GSL Version      = 2.5
## Eigen Version    = 3.3.5
## OpenBlas         = OpenBLAS 0.3.3  - DYNAMIC_ARCH NO_AFFINITY Haswell MAX_THREADS=3
##   arch           = Haswell
##   threads        = 3
##   parallel type  = threaded
##
## Command Line Input = gemma -bfile dgrp2_QC_focal_lines -maf 0.05 -d ./output/eigen_decomp.eigenD_female.txt -u ./output/eigen_decomp.eigenU_female.txt -lmm 1 -n 1 -o female_early_lmm 
##
## Date = Thu Feb  4 12:44:33 2021
##
## Summary Statistics:
## number of total individuals = 125
## number of analyzed individuals = 125
## number of covariates = 1
## number of phenotypes = 1
## number of total SNPs/var = 1609590
## number of analyzed SNPs/var = 1609590
## REMLE log-likelihood in the null model = -175.264
## MLE log-likelihood in the null model = -172.004
## pve estimate in the null model = 0.461967
## se(pve) in the null model = 0.427383
## vg estimate in the null model = 0.73509
## ve estimate in the null model = 0.536304
## beta estimate in the null model =   1.35761e-11
## se(beta) =   0.0655014
##
## Computation Time:
## total computation time = 4.63298 min 
## computation time break down: 
##      time on eigen-decomposition = 0 min 
##      time on calculating UtX = 0.0351418 min 
##      time on optimization = 3.96721 min 
##</code></pre>
</div>
<div id="male-early-life-fitness" class="section level4">
<h4>Male early-life fitness</h4>
<pre class="r"><code>cat(readLines(&quot;data/derived/output/male_early_lmm.log.txt&quot;), sep = &quot;\n&quot;)</code></pre>
<pre><code>##
## GEMMA Version    = 0.98 (2018-09-28)
## Build profile    = /gnu/store/79fw0qqlgpk7n8vll6lnlc4ahahn4gbw-profile
## GCC version      = 4.2.1
## GSL Version      = 2.5
## Eigen Version    = 3.3.5
## OpenBlas         = OpenBLAS 0.3.3  - DYNAMIC_ARCH NO_AFFINITY Haswell MAX_THREADS=3
##   arch           = Haswell
##   threads        = 3
##   parallel type  = threaded
##
## Command Line Input = gemma -bfile dgrp2_QC_focal_lines -maf 0.05 -d ./output/eigen_decomp.eigenD_male.txt -u ./output/eigen_decomp.eigenU_male.txt -lmm 1 -n 3 -o male_early_lmm 
##
## Date = Thu Feb  4 12:52:47 2021
##
## Summary Statistics:
## number of total individuals = 125
## number of analyzed individuals = 124
## number of covariates = 1
## number of phenotypes = 1
## number of total SNPs/var = 1609590
## number of analyzed SNPs/var = 1607005
## REMLE log-likelihood in the null model = -171.979
## MLE log-likelihood in the null model = -172.613
## pve estimate in the null model = 0.37414
## se(pve) in the null model = 0.308405
## vg estimate in the null model = 0.575376
## ve estimate in the null model = 0.603253
## beta estimate in the null model =   0.00234261
## se(beta) =   0.0698685
##
## Computation Time:
## total computation time = 4.10824 min 
## computation time break down: 
##      time on eigen-decomposition = 0 min 
##      time on calculating UtX = 0.0335848 min 
##      time on optimization = 3.48421 min 
##</code></pre>
</div>
<div id="female-late-life-fitness" class="section level4">
<h4>Female late-life fitness</h4>
<pre class="r"><code>cat(readLines(&quot;data/derived/output/female_late_lmm.log.txt&quot;), sep = &quot;\n&quot;)</code></pre>
<pre><code>##
## GEMMA Version    = 0.98 (2018-09-28)
## Build profile    = /gnu/store/79fw0qqlgpk7n8vll6lnlc4ahahn4gbw-profile
## GCC version      = 4.2.1
## GSL Version      = 2.5
## Eigen Version    = 3.3.5
## OpenBlas         = OpenBLAS 0.3.3  - DYNAMIC_ARCH NO_AFFINITY Haswell MAX_THREADS=3
##   arch           = Haswell
##   threads        = 3
##   parallel type  = threaded
##
## Command Line Input = gemma -bfile dgrp2_QC_focal_lines -maf 0.05 -d ./output/eigen_decomp.eigenD_female.txt -u ./output/eigen_decomp.eigenU_female.txt -lmm 1 -n 2 -o female_late_lmm 
##
## Date = Thu Feb  4 12:48:49 2021
##
## Summary Statistics:
## number of total individuals = 125
## number of analyzed individuals = 125
## number of covariates = 1
## number of phenotypes = 1
## number of total SNPs/var = 1609590
## number of analyzed SNPs/var = 1609590
## REMLE log-likelihood in the null model = -174.763
## MLE log-likelihood in the null model = -170.401
## pve estimate in the null model = 0.767479
## se(pve) in the null model = 0.438769
## vg estimate in the null model = 1.23388
## ve estimate in the null model = 0.234175
## beta estimate in the null model =   4.85539e-12
## se(beta) =   0.0432828
##
## Computation Time:
## total computation time = 4.40687 min 
## computation time break down: 
##      time on eigen-decomposition = 0 min 
##      time on calculating UtX = 0.0330177 min 
##      time on optimization = 3.77512 min 
##</code></pre>
</div>
<div id="male-late-life-fitness" class="section level4">
<h4>Male late-life fitness</h4>
<pre class="r"><code>cat(readLines(&quot;data/derived/output/male_late_lmm.log.txt&quot;), sep = &quot;\n&quot;)</code></pre>
<pre><code>##
## GEMMA Version    = 0.98 (2018-09-28)
## Build profile    = /gnu/store/79fw0qqlgpk7n8vll6lnlc4ahahn4gbw-profile
## GCC version      = 4.2.1
## GSL Version      = 2.5
## Eigen Version    = 3.3.5
## OpenBlas         = OpenBLAS 0.3.3  - DYNAMIC_ARCH NO_AFFINITY Haswell MAX_THREADS=3
##   arch           = Haswell
##   threads        = 3
##   parallel type  = threaded
##
## Command Line Input = gemma -bfile dgrp2_QC_focal_lines -maf 0.05 -d ./output/eigen_decomp.eigenD_male.txt -u ./output/eigen_decomp.eigenU_male.txt -lmm 1 -n 4 -o male_late_lmm 
##
## Date = Thu Feb  4 12:55:33 2021
##
## Summary Statistics:
## number of total individuals = 125
## number of analyzed individuals = 124
## number of covariates = 1
## number of phenotypes = 1
## number of total SNPs/var = 1609590
## number of analyzed SNPs/var = 1607005
## REMLE log-likelihood in the null model = -172.714
## MLE log-likelihood in the null model = -173.617
## pve estimate in the null model = 6.2676e-06
## se(pve) in the null model = 0.462792
## vg estimate in the null model = 9.70913e-06
## ve estimate in the null model = 0.970913
## beta estimate in the null model =   0.00434606
## se(beta) =   0.0885159
##
## Computation Time:
## total computation time = 2.9527 min 
## computation time break down: 
##      time on eigen-decomposition = 0 min 
##      time on calculating UtX = 0.0321058 min 
##      time on optimization = 2.33507 min 
##</code></pre>
<!-- #### All four traits in MV model -->
<!-- ```{r} -->
<!-- cat(readLines("data/derived/output/all_four_traits.log.txt"), sep = "\n") -->
<!-- ``` -->
</div>
</div>
<div id="add-the-allele-ids-and-minor-allele-frequencies-mafs-to-variant-annotation-database" class="section level3">
<h3>Add the allele IDs and minor allele frequencies (MAFs) to variant annotation database</h3>
<p>This part uses the full DGRP panel, because our aim is to determine how common these alleles are in the original wild population from which the DGRP was captured. These MAFs are the ones used in our statistical analyses and plots.</p>
<pre class="r"><code># Extract and save the MAFs, SNP positions, and major/minor alleles
MAFs &lt;- read.table(&quot;data/derived/plink.frq&quot;, header = TRUE, stringsAsFactors = FALSE) %&gt;% 
  mutate(position = map_chr(strsplit(SNP, split = &quot;_&quot;), function(x) x[2])) %&gt;%
  select(SNP, position, MAF, A1, A2) %&gt;% 
  rename(minor_allele = A1,
         major_allele = A2) 

db &lt;- DBI::dbConnect(RSQLite::SQLite(), &quot;data/derived/annotations.sqlite3&quot;, create = FALSE)

MAFs &lt;- tbl(db, &quot;variants&quot;) %&gt;% 
  select(SNP, FBID, site.class, distance.to.gene, chr) %&gt;% collect() %&gt;%
  full_join(MAFs, by = &quot;SNP&quot;) %&gt;%
  filter(!is.na(MAF)) %&gt;%
  mutate(site.class = replace(site.class, is.na(site.class), &quot;INTERGENIC&quot;))

# Delete the original variant annotation table from the db, and add the new one back in
db %&gt;% db_drop_table(table = &quot;variants&quot;) 
db %&gt;% copy_to(MAFs, 
               &quot;variants&quot;, temporary = FALSE, 
               indexes = list(&quot;SNP&quot;, &quot;FBID&quot;, &quot;chr&quot;, &quot;site.class&quot;)) 
rm(MAFs)</code></pre>
</div>
<div id="clean-up-the-gemma-results" class="section level3">
<h3>Clean up the GEMMA results</h3>
<p>Discard columns we don’t need, and rename the SNP column from the name assigned by GEMMA (<code>rs</code>) to something more sensible (<code>SNP</code>).</p>
<pre class="r"><code># The 4 univariate files:
c(&quot;data/derived/output/female_early_lmm.assoc.txt&quot;,
  &quot;data/derived/output/female_late_lmm.assoc.txt&quot;,
  &quot;data/derived/output/male_early_lmm.assoc.txt&quot;,
  &quot;data/derived/output/male_late_lmm.assoc.txt&quot;) %&gt;%
  lapply(function(filename){
    df &lt;- read_tsv(filename)
    names(df)[names(df) == &quot;rs&quot;] &lt;- &quot;SNP&quot;
    df %&gt;% select(SNP, beta, se, p_wald) %&gt;% 
      write_tsv(filename)
  })

# The multivariate file:
# all_four &lt;- read_tsv(&quot;data/derived/output/all_four_traits.assoc.txt&quot;) %&gt;% 
#   rename(SNP = rs,
#          female_early = beta_1, 
#          female_late  = beta_2,
#          male_early   = beta_3, 
#          male_late    = beta_4) %&gt;%
#   select(-chr, -ps, -n_miss, -allele1, -allele0, -af) %&gt;%
#   arrange(p_wald) 

# Perform FDR on p-vals, assuming we only run one test on groups of SNPs in perfect LD with each other
# p_vals &lt;- all_four %&gt;%
#   select(female_early, female_late, male_early, male_late, p_wald) %&gt;% 
#   distinct() %&gt;% 
#   select(p_wald) %&gt;%
#   mutate(p_fdr = p.adjust(p_wald, method = &quot;BH&quot;))

# all_four %&gt;%
#   left_join(p_vals, by = &quot;p_wald&quot;) %&gt;% 
#   write_tsv(&quot;data/derived/output/all_four_traits.assoc.txt&quot;)
# 
# rm(all_four)</code></pre>
</div>
<div id="perform-snp-clumping-using-plink" class="section level3">
<h3>Perform SNP clumping using PLINK</h3>
<pre class="r"><code>if(!exists(&quot;plink&quot;)) plink  &lt;- bigsnpr::download_plink()
# Use the un-manipulated DGRP bed/bim/fam files, since they don&#39;t throw an error from plink
bed &lt;- &quot;../input/dgrp2&quot;

# Remind plink to only use the SNPs that passed QC
# read_tsv(&quot;data/derived/output/female_early_lmm.assoc.txt&quot;) %&gt;% select(SNP) %&gt;%
#   write_tsv(col_names = FALSE, path = &quot;data/derived/snp_list.txt&quot;)


do_snp_clumping &lt;- function(trait){

  run_command(glue(&quot;plink --bfile {bed}&quot;, 
                   &quot; --clump output/{trait}.assoc.txt&quot;,
                   &quot; --noweb&quot;,
                   &quot; --clump-field p_wald --clump-p1 0.00001&quot;), # Each clump must contain one snp with p &lt; 10 ^ -5
              path = &quot;/data/derived&quot;)
  trait &lt;- gsub(&quot;_lmm&quot;, &quot;&quot;, trait)
  file_name &lt;- glue(&quot;data/derived/{trait}_SNP_clumps.txt&quot;)
  file.rename(&quot;data/derived/plink.clumped&quot;, file_name)
  
  clumps &lt;- read.table(file_name, header = TRUE) %&gt;% 
    as_tibble() %&gt;%
    rename(index_SNP = SNP,
           index_SNP_p_value = P,
           num_SNPs_in_clump = TOTAL,
           not_sig = NSIG, # Number of clumped SNPs that are not significant ( p &gt; 0.05 )
           sig_p05 = S05, # Number of clumped SNPs 0.01 &lt; p &lt; 0.05
           sig_p01 = S01, # Number of clumped SNPs 0.001 &lt; p &lt; 0.01
           sig_p001 = S001, # Number of clumped SNPs 0.0001 &lt; p &lt; 0.001 
           sig_p0001 = S0001, # Number of clumped SNPs p &lt; 0.0001
           other_snps = SP2) %&gt;%
    mutate(other_snps = gsub(&quot;\\(1\\),&quot;, &quot;, &quot;, other_snps),
           other_snps = gsub(&quot;\\(1\\)&quot;, &quot;&quot;, other_snps),
           other_snps = replace(other_snps, other_snps == &quot;NONE&quot;, NA)) %&gt;%
    select(-CHR, -F, -BP) 
  
  SNPs &lt;- apply(clumps, 1, function(x) {
    res &lt;- c(x[1], strsplit(x[9], split = &quot;, &quot;)[[1]])
    res[!is.na(res)]
  })
  
  db_local &lt;- tbl(db, &quot;variants&quot;) %&gt;% select(SNP, FBID) %&gt;% collect() 
  clumps$FBIDs &lt;- lapply(SNPs, function(x) {
    focal &lt;- db_local %&gt;% filter(SNP %in% x) 
    if(nrow(focal) == 0) return(NA)
    focal %&gt;% pull(FBID) %&gt;% unique() %&gt;% paste0(collapse = &quot;, &quot;)
    }) %&gt;% unlist()
  
  db_local &lt;- tbl(db, &quot;genes&quot;) %&gt;% collect()
  clumps$genes &lt;- lapply(clumps$FBIDs, function(x) {
    if(is.na(x)) return(NA)
    FB &lt;- strsplit(x, split = &quot;, &quot;)[[1]]
    return(db_local %&gt;% filter(FBID %in% FB) %&gt;% pull(gene_name) %&gt;% paste0(collapse = &quot;, &quot;))
  }) %&gt;% unlist()
  
  write_tsv(clumps, file_name)
  unlink(&quot;data/derived/plink.log&quot;)
}

lapply(c(&quot;female_early_lmm&quot;, &quot;female_late_lmm&quot;, &quot;male_early_lmm&quot;, &quot;male_late_lmm&quot;), do_snp_clumping)</code></pre>
</div>
</div>
<div id="concatenate-the-results-of-the-four-univariate-gwas" class="section level2">
<h2>Concatenate the results of the four univariate GWAS</h2>
<p>Load up the GWAS results, which were produced by using linear mixed models implemented in GEMMA, and arrange the data in a ‘wide’ format, where each row is one SNP, and the columns hold the estimates of <span class="math inline">\(\beta\)</span>, the standard error of <span class="math inline">\(\beta\)</span>, and the p-value for the GEMMA association tests on each of the four fitness traits.</p>
<pre class="r"><code>load_gwas_results &lt;- function(fitness.component){
  new_names &lt;- c(x = &quot;beta&quot;, y = &quot;se&quot;, z = &quot;p_wald&quot;)
  names(new_names) &lt;- c(paste(&quot;beta_&quot;, fitness.component, sep = &quot;&quot;), 
                        paste(&quot;SE_&quot;, fitness.component, sep = &quot;&quot;), 
                        paste(&quot;pvalue_&quot;, fitness.component, sep = &quot;&quot;))
  
  paste(&quot;data/derived/output/&quot;, fitness.component, &quot;_lmm.assoc.txt&quot;, sep = &quot;&quot;) %&gt;%
    read_tsv() %&gt;%
    select(SNP, beta, se, p_wald) %&gt;%
    rename(!!new_names)
}
all_univariate_lmm_results &lt;- load_gwas_results(&quot;female_early&quot;) %&gt;%
  full_join(load_gwas_results(&quot;female_late&quot;), by = &quot;SNP&quot;) %&gt;%
  full_join(load_gwas_results(&quot;male_early&quot;), by = &quot;SNP&quot;) %&gt;%
  full_join(load_gwas_results(&quot;male_late&quot;), by = &quot;SNP&quot;) </code></pre>
</div>
<div id="prune-snps-that-are-in-100-linkage-disequilibrium" class="section level2">
<h2>Prune SNPs that are in 100% linkage disequilibrium</h2>
<p>Because GEMMA is quick and easy to run, we did not bother working out how to edit PLINK files to identify SNPs that are in complete linkage disequilibrium with one another (and there is lots of short- and long-range LD in the dataset). However, it is easy to perform LD pruning at this stage, because we can take advantage of the fact that SNPs in perfect LD with each other will have identical estimates of <span class="math inline">\(|\beta|\)</span> and its standard error, for all four fitness traits. The following code groups together SNPs that have identical association test results, producing a data frame in which the number of rows is equal to the number of unique datasets (i.e. combinations of genotypes and phenotypes) that were statistically analysed by GEMMA.</p>
<pre class="r"><code># Group loci with identical GWAS results (these are in 100% LD with each other)
all_univariate_lmm_results &lt;- all_univariate_lmm_results %&gt;%
  mutate(pasted = paste(beta_female_early, beta_female_late, beta_male_early, beta_male_late, 
                        SE_female_early, SE_female_late, SE_male_early, SE_male_late)) %&gt;%
  group_by(pasted) %&gt;%
  summarise(SNPs = paste0(SNP, collapse = &quot;, &quot;),    # If there are multiple SNPs, concatenate their names
            beta_female_early = beta_female_early[1], 
            beta_female_late = beta_female_late[1], 
            beta_male_early = beta_male_early[1], 
            beta_male_late = beta_male_late[1],
            SE_female_early = SE_female_early[1], 
            SE_female_late = SE_female_late[1], 
            SE_male_early = SE_male_early[1], 
            SE_male_late = SE_male_late[1],
            pvalue_female_early = pvalue_female_early[1], 
            pvalue_female_late = pvalue_female_late[1], 
            pvalue_male_early = pvalue_male_early[1], 
            pvalue_male_late = pvalue_male_late[1]) %&gt;%
  ungroup() %&gt;% select(-pasted) %&gt;% 
  arrange(SNPs)


all_univariate_lmm_results &lt;- read_csv(&quot;data/derived/all_univariate_GEMMA_results.csv&quot;)
# a handful of SNPs with low MAF could not be estimated and they have beta and SE == NA, so remove them now
# I think these are SNPs where the only lines with the minor allele were the lines where we measured female but not male fitness
SNPs_to_remove &lt;- all_univariate_lmm_results$SNPs[!complete.cases(all_univariate_lmm_results)] 

all_univariate_lmm_results &lt;- all_univariate_lmm_results %&gt;% 
  filter(!(SNPs %in% SNPs_to_remove))

write_csv(all_univariate_lmm_results, path = &quot;data/derived/all_univariate_GEMMA_results.csv&quot;)
unlink(&quot;data/derived/output/female_early_lmm.assoc.txt&quot;)
unlink(&quot;data/derived/output/female_late_lmm.assoc.txt&quot;)
unlink(&quot;data/derived/output/male_early_lmm.assoc.txt&quot;)
unlink(&quot;data/derived/output/male_late_lmm.assoc.txt&quot;)</code></pre>
<!-- ## Run Bayesian Sparse Linear Mixed Models -->
<!-- Here is a screenshot from the relevant part of the GEMMA manual, explaining how the BSLMMs work, and the key parameters that are estimated: -->
<!-- !["Screenshot from the GEMMA manual"](data/input/GEMMA_manual_screenshot.png) -->
<!-- I run these with a burn-in period of 50,000 iterations, then 10m sampling iterations, recording every 1000^{th} iteration. This may seem extreme, but I picked it because there was massive auto-correlation in the MCMC chain with the default settings. -->
<!-- Glossary of abbreviations and parameters used by GEMMA: -->
<!--  - PVE: "Proportion of (phenotypic) variance explained", by the SNPs and the random effect terms together -->
<!--  - PGE: "Proportion of _genetic_ variance explained by the sparse effects terms".  -->
<!--  Useful quote from Zhou: I think you can treat both h and rho as parameters and only rely on only PVE and PGE. The result essentially says that a total 3414 SNPs explain approximately 33% of phenotypic variance (i.e. PVE=0.33). Among these 3414 SNPs, a small proportion of them (\approx 158) have relatively large effects and explain a total of 48% PVE (i.e. PGE=0.48). Although these 158 SNPs have relatively larger effects than the rest of the SNPs, their absolute effect sizes are still small. All these quantities provide a description of the genetic architecture of the phenotype, and give much more information than simply categorizing a trait into polygenic vs oligogenic.  -->
<!-- ### Female early-life fitness -->
<!-- ```{r bslmm1} -->
<!-- run_command("gemma -bfile trimmed_DGRP -maf 0.05 -n 1 -bslmm 1 -w 50000 -s 10000000 -rpace 1000 -seed 1 -o female_early_bslmm") -->
<!-- ``` -->
<!-- ```{r} -->
<!-- make_trimmed_BED <- function(phenotypes){ -->
<!--   # Define a function to add phenotype data to a .fam file, for later GWAS analysis -->
<!--   # 'phenotypes' needs to have a column called 'line' -->
<!--   add_phenotypes_to_fam <- function(filepath, phenotypes){ -->
<!--     read.delim(filepath, header = FALSE, stringsAsFactors = FALSE) %>%  -->
<!--       select(V1, V2, V3, V4, V5) %>% # Get all the non-phenotype columns -->
<!--       left_join(phenotypes,  -->
<!--                 by = c("V1" = "line")) %>% -->
<!--       write.table(file = filepath,  -->
<!--                   col.names = FALSE, row.names = FALSE,  -->
<!--                   quote = FALSE, sep = "\t") -->
<!--   } -->
<!-- #  if(file.exists("data/derived/trimmed_DGRP.bed")) return(NULL) -->
<!--   # Load the BED/BIM/FAM files as a bigsnp object -->
<!--   bigsnp <- snp_readBed("data/input/dgrp2.bed", backingfile = tempfile()) -->
<!--   bigsnp_attached <- snp_attach(bigsnp) -->
<!--   ###################################################### -->
<!--   # 1. Perform simple SNP quality control using PLINK -->
<!--   ###################################################### -->
<!--   bedfile <- "data/input/dgrp2.bed" -->
<!--   plink <- download_plink() -->
<!--   bigsnp <- snp_plinkQC(plink.path = plink, -->
<!--                         prefix.in = "data/input/dgrp2", -->
<!--                         prefix.out = tempfile(), -->
<!--                         maf = 0.05, # MAF >= 0.05 -->
<!--                         geno = 0.05,   # acceptable number missing genotypes per locus: none -->
<!--                         mind = 0.1,   # acceptable proportion of missing genotypes per individual (i.e. DGRP line): none -->
<!--                         hwe = 0,    # do not filter by HWE test p-value (p = 0 is kept) -->
<!--                         autosome.only = FALSE) # Keep X chromosome -->
<!--   bigsnp <- snp_readBed(bigsnp) -->
<!--   bigsnp_attached <- snp_attach(bigsnp) -->
<!--   ###### Important messages from this QC: ######## -->
<!--   # Total genotyping rate is 0.956183. -->
<!--   # 1050867 variants removed due to missing genotype data (--geno). -->
<!--   # 2266579 variants removed due to minor allele threshold(s) -->
<!--   # (--maf/--max-maf/--mac/--max-mac). -->
<!--   # 1120981 variants and 193 people pass filters and QC. -->
<!--   # cull the PLINK files to just the DGRP lines that we measured -->
<!--   focal.lines <- phenotypes$line %>% as.character() -->
<!--   bigsnp_attached <- subset(bigsnp_attached,  -->
<!--                             ind.row = bigsnp_attached$fam$family.ID %in% focal.lines) %>% -->
<!--     snp_attach() -->
<!--   beagle <- download_beagle() -->
<!--   # Delete these files, because snp_writeBed() throws an error rather than over-writing -->
<!--   unlink(c("data/derived/dgrp2_after_QC.bed",  -->
<!--            "data/derived/dgrp2_after_QC.bim", "data/derived/dgrp2_after_QC.fam"))  -->
<!--   # Write the QC'd BED files for all 205 DGRP lines to disk -->
<!--   # This is is needed to use PLINK on them, and also because we now have a SNP set that is not pruned for LD -->
<!--   snp_writeBed(bigsnp_attached, "data/derived/dgrp2_after_QC.bed") -->
<!--   # Add our phenotype data to this new .fam file -->
<!--   add_phenotypes_to_fam("data/derived/dgrp2_after_QC.fam",  -->
<!--                         phenotypes %>% select(-block)) -->
<!--   ################################################################## -->
<!--   # 2. Remove SNPs that do not have MAF < 0.05 within our 115 lines -->
<!--   ################################################################## -->
<!--   bigsnp <- snp_plinkQC(plink.path = plink, -->
<!--                         prefix.in = "data/derived/dgrp2_after_QC", -->
<!--                         prefix.out = tempfile(), -->
<!--                         maf = 0.05, -->
<!--                         geno = 0, -->
<!--                         mind = 1, -->
<!--                         hwe = 0, -->
<!--                         autosome.only = FALSE) -->
<!--   bigsnp_attached <- snp_readBed(bigsnp) %>% snp_attach() -->
<!--   # unlink(temp.file) -->
<!--   ##### PLINK messages: ###### -->
<!--   # 1637 variants removed due to minor allele threshold(s) -->
<!--   # (--maf/--max-maf/--mac/--max-mac). -->
<!--   # 12954 variants and 115 people pass filters and QC. -->
<!--   ################################################################## -->
<!--   # 3. Perform short-range SNP clumping, using snp_clumping function -->
<!--   ################################################################## -->
<!--   # Sum the significant correlations of each SNP to each other SNP -->
<!--   summed_correlations <- apply(snp_cor(bigsnp_attached$genotypes), 1, sum) %>% -->
<!--     round(2) -->
<!--   # Identify 1 SNP from each 'clump' of highly linked SNPs -->
<!--   # Nearby SNPs that are correlated with a squared-corr of at least .1, i.e. r = +/- 0.316, are counted as clumped -->
<!--   snp_clumps <- snp_clumping(G = bigsnp_attached$genotypes,  -->
<!--                              infos.chr = bigsnp_attached$map$chromosome,  -->
<!--                              thr.r2 = 0.2, -->
<!--                              size = 1000, # 1kB windows -->
<!--                              is.size.in.bp = TRUE, -->
<!--                              infos.pos = bigsnp_attached$map$physical.pos)  -->
<!--   # After this there are 7523 SNPs left -->
<!--   clumped_subset <- subset(bigsnp_attached, ind.col = snp_clumps) %>% snp_attach() -->
<!--   ###################################################### -->
<!--   # 4. Perform long-range LD pruning using snp_autoSVD -->
<!--   ###################################################### -->
<!--   SVD_output <- snp_autoSVD(G = clumped_subset$genotypes, -->
<!--                             infos.chr = clumped_subset$map$chromosome, -->
<!--                             infos.pos = clumped_subset$map$physical.pos, -->
<!--                             thr.r2 = 0.2) -->
<!--   # Vector of SNP IDs to keep -->
<!--   SVD_output <- attributes(SVD_output)$subset -->
<!--   # After this there are 6897 SNPs left -->
<!--   # Retain all the SNPs that passed both types of clumping -->
<!--   to.keep <- snp_clumps[SVD_output] -->
<!--   clumped_subset2 <- subset(bigsnp_attached, ind.col = to.keep) %>% snp_attach() -->
<!--   summed_correlations <- data.frame(id = clumped_subset2$map$marker.ID, -->
<!--                                     summed_corr = summed_correlations[to.keep]) -->
<!--   # Delete these files, because snp_writeBed() throws an error rather than over-writing -->
<!--   unlink(c("data/derived/trimmed_DGRP.bed",  -->
<!--            "data/derived/trimmed_DGRP.bim", "data/derived/trimmed_DGRP.fam"))  -->
<!--   # Save the fully-pruned SNP data, and the SNP "tagging" data -->
<!--   snp_writeBed(clumped_subset2, "data/derived/trimmed_DGRP.bed") -->
<!--   write.csv(summed_correlations, "data/derived/summed_interSNP_correlations.csv", row.names = FALSE) -->
<!--   # Lastly, add our phenotype data to the new .fam file -->
<!--   add_phenotypes_to_fam("data/derived/trimmed_DGRP.fam",  -->
<!--                         phenotypes %>% select(-block)) -->
<!-- } -->
<!-- make_trimmed_BED(phenotypes = predicted_line_means) -->
<!-- if(file.exists('data/derived/trimmed_DGRP.bk')) unlink('data/derived/trimmed_DGRP.bk') -->
<!-- dgrp_bed <- snp_readBed("data/derived/trimmed_DGRP.bed") %>% snp_attach() -->
<!-- ``` -->
<br>
<p>
<button type="button" class="btn btn-default btn-workflowr btn-workflowr-sessioninfo" data-toggle="collapse" data-target="#workflowr-sessioninfo" style="display: block;">
<span class="glyphicon glyphicon-wrench" aria-hidden="true"></span> Session information
</button>
</p>
<div id="workflowr-sessioninfo" class="collapse">
<pre class="r"><code>sessionInfo()</code></pre>
<pre><code>R version 4.0.3 (2020-10-10)
Platform: x86_64-apple-darwin17.0 (64-bit)
Running under: macOS Catalina 10.15.7

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.0/Resources/lib/libRblas.dylib
LAPACK: /Library/Frameworks/R.framework/Versions/4.0/Resources/lib/libRlapack.dylib

locale:
[1] en_GB.UTF-8/en_GB.UTF-8/en_GB.UTF-8/C/en_GB.UTF-8/en_GB.UTF-8

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] future.apply_1.5.0 future_1.17.0      purrr_0.3.4        pander_0.6.3      
 [5] readr_1.3.1        bigsnpr_1.3.0      bigstatsr_1.2.3    glue_1.4.2        
 [9] ggdendro_0.1-20    ggplot2_3.3.2      dplyr_1.0.0        workflowr_1.6.2   

loaded via a namespace (and not attached):
 [1] tidyselect_1.1.0   xfun_0.19          listenv_0.8.0      lattice_0.20-41   
 [5] bigassertr_0.1.3   colorspace_1.4-1   vctrs_0.3.0        generics_0.0.2    
 [9] htmltools_0.5.0    yaml_2.2.1         rlang_0.4.6        later_1.0.0       
[13] pillar_1.4.4       withr_2.2.0        foreach_1.5.0      lifecycle_0.2.0   
[17] stringr_1.4.0      munsell_0.5.0      gtable_0.3.0       codetools_0.2-16  
[21] evaluate_0.14      knitr_1.30         doParallel_1.0.15  httpuv_1.5.3.1    
[25] parallel_4.0.3     Rcpp_1.0.4.6       promises_1.1.0     scales_1.1.1      
[29] backports_1.1.7    fs_1.4.1           hms_0.5.3          digest_0.6.25     
[33] stringi_1.5.3      bigparallelr_0.2.3 grid_4.0.3         rprojroot_1.3-2   
[37] cowplot_1.0.0      tools_4.0.3        magrittr_2.0.1     tibble_3.0.1      
[41] crayon_1.3.4       whisker_0.4        pkgconfig_2.0.3    MASS_7.3-53       
[45] ellipsis_0.3.1     Matrix_1.2-18      data.table_1.12.8  rmarkdown_2.5     
[49] iterators_1.0.12   R6_2.4.1           globals_0.12.5     flock_0.7         
[53] git2r_0.27.1       compiler_4.0.3    </code></pre>
</div>
</div>


<!-- Adjust MathJax settings so that all math formulae are shown using
TeX fonts only; see
http://docs.mathjax.org/en/latest/configuration.html.  This will make
the presentation more consistent at the cost of the webpage sometimes
taking slightly longer to load. Note that this only works because the
footer is added to webpages before the MathJax javascript. -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    "HTML-CSS": { availableFonts: ["TeX"] }
  });
</script>


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeCodeFolding("hide" === "show");
});
</script>

<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
